import { DOCUMENT } from '@angular/common';
import { DestroyRef, InjectionToken, inject, signal, } from '@angular/core';
import { assertInjector } from 'ngxtension/assert-injector';
export const NGXTENSION_LOCAL_STORAGE = new InjectionToken('NGXTENSION_LOCAL_STORAGE', {
    providedIn: 'root',
    factory: () => localStorage, // this would be the default
});
export function provideLocalStorageImpl(impl) {
    return {
        provide: NGXTENSION_LOCAL_STORAGE,
        useValue: impl,
    };
}
function isLocalStorageWithDefaultValue(options) {
    return 'defaultValue' in options;
}
function isFunction(value) {
    return typeof value === 'function';
}
function goodTry(tryFn, defaultValue) {
    try {
        return tryFn();
    }
    catch {
        return defaultValue;
    }
}
function parseJSON(value) {
    return value === 'undefined' ? undefined : JSON.parse(value);
}
export const injectLocalStorage = (key, options = {}) => {
    if (isLocalStorageWithDefaultValue(options)) {
        const defaultValue = isFunction(options.defaultValue)
            ? options.defaultValue()
            : options.defaultValue;
        return internalInjectLocalStorage(key, options, defaultValue);
    }
    return internalInjectLocalStorage(key, options, undefined);
};
const internalInjectLocalStorage = (key, options, defaultValue) => {
    const stringify = isFunction(options.stringify)
        ? options.stringify
        : JSON.stringify;
    const parse = isFunction(options.parse) ? options.parse : parseJSON;
    const storageSync = options.storageSync ?? true;
    return assertInjector(injectLocalStorage, options.injector, () => {
        const localStorage = inject(NGXTENSION_LOCAL_STORAGE);
        const destroyRef = inject(DestroyRef);
        const window = inject(DOCUMENT).defaultView;
        if (!window) {
            throw new Error('Cannot access to window element');
        }
        const initialStoredValue = goodTry(() => localStorage.getItem(key), null);
        const internalSignal = signal(initialStoredValue
            ? goodTry(() => parse(initialStoredValue), defaultValue)
            : defaultValue);
        const syncValueWithLocalStorage = (value) => {
            const newValue = goodTry(() => (value === undefined ? null : stringify(value)), null);
            try {
                if (newValue === localStorage.getItem(key)) {
                    return;
                }
                if (newValue === null) {
                    localStorage.removeItem(key);
                }
                else {
                    localStorage.setItem(key, newValue);
                }
                // We notify other consumers in this tab about changing the value in the store for synchronization
                window.dispatchEvent(new StorageEvent(`storage`, {
                    key,
                    newValue,
                    storageArea: localStorage,
                }));
            }
            catch {
                // ignore errors
            }
        };
        if (storageSync) {
            const originalSet = internalSignal.set;
            const originalUpdate = internalSignal.update;
            const set = (newValue) => {
                // set the value in the signal using the original set function
                originalSet(newValue);
                // then we refresh the value in localStorage and notify other consumers in this tab about the change
                syncValueWithLocalStorage(newValue);
            };
            const update = (updateFn) => {
                let newValue;
                // set the value in the signal using the original set function
                originalUpdate((value) => (newValue = updateFn(value)));
                // then we refresh the value in localStorage and notify other consumers in this tab about the change
                syncValueWithLocalStorage(newValue);
            };
            internalSignal.set = set;
            internalSignal.update = update;
            const onStorage = (event) => {
                if (event.storageArea === localStorage && event.key === key) {
                    const newValue = event.newValue !== null
                        ? parse(event.newValue)
                        : defaultValue;
                    internalSignal.set(newValue);
                }
            };
            window.addEventListener('storage', onStorage);
            destroyRef.onDestroy(() => {
                window.removeEventListener('storage', onStorage);
            });
        }
        return internalSignal;
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0LWxvY2FsLXN0b3JhZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neHRlbnNpb24vaW5qZWN0LWxvY2FsLXN0b3JhZ2Uvc3JjL2luamVjdC1sb2NhbC1zdG9yYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQ04sVUFBVSxFQUNWLGNBQWMsRUFDZCxNQUFNLEVBQ04sTUFBTSxHQUdOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU1RCxNQUFNLENBQUMsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLGNBQWMsQ0FDekQsMEJBQTBCLEVBQzFCO0lBQ0MsVUFBVSxFQUFFLE1BQU07SUFDbEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLFlBQVksRUFBRSw0QkFBNEI7Q0FDekQsQ0FDRCxDQUFDO0FBRUYsTUFBTSxVQUFVLHVCQUF1QixDQUFDLElBQW9DO0lBQzNFLE9BQU87UUFDTixPQUFPLEVBQUUsd0JBQXdCO1FBQ2pDLFFBQVEsRUFBRSxJQUFJO0tBQ2QsQ0FBQztBQUNILENBQUM7QUEyQ0QsU0FBUyw4QkFBOEIsQ0FDdEMsT0FBK0I7SUFFL0IsT0FBTyxjQUFjLElBQUksT0FBTyxDQUFDO0FBQ2xDLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxLQUFjO0lBQ2pDLE9BQU8sT0FBTyxLQUFLLEtBQUssVUFBVSxDQUFDO0FBQ3BDLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBSSxLQUFjLEVBQUUsWUFBZTtJQUNsRCxJQUFJLENBQUM7UUFDSixPQUFPLEtBQUssRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFBQyxNQUFNLENBQUM7UUFDUixPQUFPLFlBQVksQ0FBQztJQUNyQixDQUFDO0FBQ0YsQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLEtBQWE7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QkFDN0QsTUFBTSxRQUFRLEdBQ2IsS0FBSyxDQUFDLFFBQVEsS0FBSyxJQUFJO3dCQUN0QixDQUFDLENBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQU87d0JBQzlCLENBQUMsQ0FBQyxZQUFZLENBQUM7b0JBQ2pCLGNBQWMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzlCLENBQUM7WUFDRixDQUFDLENBQUM7WUFFRixNQUFNLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzlDLFVBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUN6QixNQUFNLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ2xELENBQUMsQ0FBQyxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sY0FBYyxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcblx0RGVzdHJveVJlZixcblx0SW5qZWN0aW9uVG9rZW4sXG5cdGluamVjdCxcblx0c2lnbmFsLFxuXHR0eXBlIEluamVjdG9yLFxuXHR0eXBlIFdyaXRhYmxlU2lnbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGFzc2VydEluamVjdG9yIH0gZnJvbSAnbmd4dGVuc2lvbi9hc3NlcnQtaW5qZWN0b3InO1xuXG5leHBvcnQgY29uc3QgTkdYVEVOU0lPTl9MT0NBTF9TVE9SQUdFID0gbmV3IEluamVjdGlvblRva2VuKFxuXHQnTkdYVEVOU0lPTl9MT0NBTF9TVE9SQUdFJyxcblx0e1xuXHRcdHByb3ZpZGVkSW46ICdyb290Jyxcblx0XHRmYWN0b3J5OiAoKSA9PiBsb2NhbFN0b3JhZ2UsIC8vIHRoaXMgd291bGQgYmUgdGhlIGRlZmF1bHRcblx0fSxcbik7XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlTG9jYWxTdG9yYWdlSW1wbChpbXBsOiB0eXBlb2YgZ2xvYmFsVGhpcy5sb2NhbFN0b3JhZ2UpIHtcblx0cmV0dXJuIHtcblx0XHRwcm92aWRlOiBOR1hURU5TSU9OX0xPQ0FMX1NUT1JBR0UsXG5cdFx0dXNlVmFsdWU6IGltcGwsXG5cdH07XG59XG5cbi8qKlxuICogT3B0aW9ucyB0byBvdmVycmlkZSB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUgbG9jYWwgc3RvcmFnZSBzaWduYWwuXG4gKi9cbmV4cG9ydCB0eXBlIExvY2FsU3RvcmFnZU9wdGlvbnNOb0RlZmF1bHQgPSB7XG5cdC8qKlxuXHQgKlxuXHQgKiBEZXRlcm1pbmVzIGlmIGxvY2FsIHN0b3JhZ2Ugc3luY3Mgd2l0aCB0aGUgc2lnbmFsLlxuXHQgKiBXaGVuIHRydWUsIHVwZGF0ZXMgaW4gb25lIHRhYiByZWZsZWN0IGluIG90aGVycywgaWRlYWwgZm9yIHNoYXJlZC1zdGF0ZSBhcHBzLlxuXHQgKiBEZWZhdWx0cyB0byB0cnVlLlxuXHQgKi9cblx0c3RvcmFnZVN5bmM/OiBib29sZWFuO1xuXHQvKipcblx0ICogT3ZlcnJpZGUgdGhlIGRlZmF1bHQgSlNPTi5zdHJpbmdpZnkgZnVuY3Rpb24gZm9yIGN1c3RvbSBzZXJpYWxpemF0aW9uLlxuXHQgKiBAcGFyYW0gdmFsdWVcblx0ICovXG5cdHN0cmluZ2lmeT86ICh2YWx1ZTogdW5rbm93bikgPT4gc3RyaW5nO1xuXHQvKipcblx0ICogT3ZlcnJpZGUgdGhlIGRlZmF1bHQgSlNPTi5wYXJzZSBmdW5jdGlvbiBmb3IgY3VzdG9tIGRlc2VyaWFsaXphdGlvbi5cblx0ICogQHBhcmFtIHZhbHVlXG5cdCAqL1xuXHRwYXJzZT86ICh2YWx1ZTogc3RyaW5nKSA9PiB1bmtub3duO1xuXG5cdC8qKlxuXHQgKiBJbmplY3RvciBmb3IgdGhlIEluamVjdGlvbiBDb250ZXh0XG5cdCAqL1xuXHRpbmplY3Rvcj86IEluamVjdG9yO1xufTtcblxuZXhwb3J0IHR5cGUgTG9jYWxTdG9yYWdlT3B0aW9uc1dpdGhEZWZhdWx0VmFsdWU8VD4gPVxuXHRMb2NhbFN0b3JhZ2VPcHRpb25zTm9EZWZhdWx0ICYge1xuXHRcdC8qKlxuXHRcdCAqIERlZmF1bHQgdmFsdWUgZm9yIHRoZSBzaWduYWwuXG5cdFx0ICogQ2FuIGJlIGEgdmFsdWUgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHZhbHVlLlxuXHRcdCAqL1xuXHRcdGRlZmF1bHRWYWx1ZTogVCB8ICgoKSA9PiBUKTtcblx0fTtcblxuZXhwb3J0IHR5cGUgTG9jYWxTdG9yYWdlT3B0aW9uczxUPiA9XG5cdHwgTG9jYWxTdG9yYWdlT3B0aW9uc05vRGVmYXVsdFxuXHR8IExvY2FsU3RvcmFnZU9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlPFQ+O1xuXG5mdW5jdGlvbiBpc0xvY2FsU3RvcmFnZVdpdGhEZWZhdWx0VmFsdWU8VD4oXG5cdG9wdGlvbnM6IExvY2FsU3RvcmFnZU9wdGlvbnM8VD4sXG4pOiBvcHRpb25zIGlzIExvY2FsU3RvcmFnZU9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlPFQ+IHtcblx0cmV0dXJuICdkZWZhdWx0VmFsdWUnIGluIG9wdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWU6IHVua25vd24pOiB2YWx1ZSBpcyAoLi4uYXJnczogdW5rbm93bltdKSA9PiB1bmtub3duIHtcblx0cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJztcbn1cblxuZnVuY3Rpb24gZ29vZFRyeTxUPih0cnlGbjogKCkgPT4gVCwgZGVmYXVsdFZhbHVlOiBUKTogVCB7XG5cdHRyeSB7XG5cdFx0cmV0dXJuIHRyeUZuKCk7XG5cdH0gY2F0Y2gge1xuXHRcdHJldHVybiBkZWZhdWx0VmFsdWU7XG5cdH1cbn1cblxuZnVuY3Rpb24gcGFyc2VKU09OKHZhbHVlOiBzdHJpbmcpOiB1bmtub3duIHtcblx0cmV0dXJuIHZhbHVlID09PSAndW5kZWZpbmVkJyA/IHVuZGVmaW5lZCA6IEpTT04ucGFyc2UodmFsdWUpO1xufVxuXG5leHBvcnQgY29uc3QgaW5qZWN0TG9jYWxTdG9yYWdlOiB7XG5cdDxUPihcblx0XHRrZXk6IHN0cmluZyxcblx0XHRvcHRpb25zOiBMb2NhbFN0b3JhZ2VPcHRpb25zV2l0aERlZmF1bHRWYWx1ZTxUPixcblx0KTogV3JpdGFibGVTaWduYWw8VD47XG5cdDxUPihcblx0XHRrZXk6IHN0cmluZyxcblx0XHRvcHRpb25zPzogTG9jYWxTdG9yYWdlT3B0aW9uc05vRGVmYXVsdCxcblx0KTogV3JpdGFibGVTaWduYWw8VCB8IHVuZGVmaW5lZD47XG59ID0gPFQ+KFxuXHRrZXk6IHN0cmluZyxcblx0b3B0aW9uczogTG9jYWxTdG9yYWdlT3B0aW9uczxUPiA9IHt9LFxuKTogV3JpdGFibGVTaWduYWw8VCB8IHVuZGVmaW5lZD4gPT4ge1xuXHRpZiAoaXNMb2NhbFN0b3JhZ2VXaXRoRGVmYXVsdFZhbHVlKG9wdGlvbnMpKSB7XG5cdFx0Y29uc3QgZGVmYXVsdFZhbHVlID0gaXNGdW5jdGlvbihvcHRpb25zLmRlZmF1bHRWYWx1ZSlcblx0XHRcdD8gb3B0aW9ucy5kZWZhdWx0VmFsdWUoKVxuXHRcdFx0OiBvcHRpb25zLmRlZmF1bHRWYWx1ZTtcblxuXHRcdHJldHVybiBpbnRlcm5hbEluamVjdExvY2FsU3RvcmFnZTxUPihrZXksIG9wdGlvbnMsIGRlZmF1bHRWYWx1ZSk7XG5cdH1cblx0cmV0dXJuIGludGVybmFsSW5qZWN0TG9jYWxTdG9yYWdlPFQgfCB1bmRlZmluZWQ+KGtleSwgb3B0aW9ucywgdW5kZWZpbmVkKTtcbn07XG5cbmNvbnN0IGludGVybmFsSW5qZWN0TG9jYWxTdG9yYWdlID0gPFI+KFxuXHRrZXk6IHN0cmluZyxcblx0b3B0aW9uczogTG9jYWxTdG9yYWdlT3B0aW9uczxSPixcblx0ZGVmYXVsdFZhbHVlOiBSLFxuKTogV3JpdGFibGVTaWduYWw8Uj4gPT4ge1xuXHRjb25zdCBzdHJpbmdpZnkgPSBpc0Z1bmN0aW9uKG9wdGlvbnMuc3RyaW5naWZ5KVxuXHRcdD8gb3B0aW9ucy5zdHJpbmdpZnlcblx0XHQ6IEpTT04uc3RyaW5naWZ5O1xuXHRjb25zdCBwYXJzZSA9IGlzRnVuY3Rpb24ob3B0aW9ucy5wYXJzZSkgPyBvcHRpb25zLnBhcnNlIDogcGFyc2VKU09OO1xuXHRjb25zdCBzdG9yYWdlU3luYyA9IG9wdGlvbnMuc3RvcmFnZVN5bmMgPz8gdHJ1ZTtcblx0cmV0dXJuIGFzc2VydEluamVjdG9yKGluamVjdExvY2FsU3RvcmFnZSwgb3B0aW9ucy5pbmplY3RvciwgKCkgPT4ge1xuXHRcdGNvbnN0IGxvY2FsU3RvcmFnZSA9IGluamVjdChOR1hURU5TSU9OX0xPQ0FMX1NUT1JBR0UpO1xuXHRcdGNvbnN0IGRlc3Ryb3lSZWYgPSBpbmplY3QoRGVzdHJveVJlZik7XG5cdFx0Y29uc3Qgd2luZG93ID0gaW5qZWN0KERPQ1VNRU5UKS5kZWZhdWx0VmlldztcblxuXHRcdGlmICghd2luZG93KSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBhY2Nlc3MgdG8gd2luZG93IGVsZW1lbnQnKTtcblx0XHR9XG5cblx0XHRjb25zdCBpbml0aWFsU3RvcmVkVmFsdWUgPSBnb29kVHJ5KCgpID0+IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSksIG51bGwpO1xuXHRcdGNvbnN0IGludGVybmFsU2lnbmFsID0gc2lnbmFsPFI+KFxuXHRcdFx0aW5pdGlhbFN0b3JlZFZhbHVlXG5cdFx0XHRcdD8gZ29vZFRyeSgoKSA9PiBwYXJzZShpbml0aWFsU3RvcmVkVmFsdWUpIGFzIFIsIGRlZmF1bHRWYWx1ZSlcblx0XHRcdFx0OiBkZWZhdWx0VmFsdWUsXG5cdFx0KTtcblxuXHRcdGNvbnN0IHN5bmNWYWx1ZVdpdGhMb2NhbFN0b3JhZ2UgPSAodmFsdWU6IFIpOiB2b2lkID0+IHtcblx0XHRcdGNvbnN0IG5ld1ZhbHVlID0gZ29vZFRyeShcblx0XHRcdFx0KCkgPT4gKHZhbHVlID09PSB1bmRlZmluZWQgPyBudWxsIDogc3RyaW5naWZ5KHZhbHVlKSksXG5cdFx0XHRcdG51bGwsXG5cdFx0XHQpO1xuXG5cdFx0XHR0cnkge1xuXHRcdFx0XHRpZiAobmV3VmFsdWUgPT09IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSkpIHtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAobmV3VmFsdWUgPT09IG51bGwpIHtcblx0XHRcdFx0XHRsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgbmV3VmFsdWUpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly8gV2Ugbm90aWZ5IG90aGVyIGNvbnN1bWVycyBpbiB0aGlzIHRhYiBhYm91dCBjaGFuZ2luZyB0aGUgdmFsdWUgaW4gdGhlIHN0b3JlIGZvciBzeW5jaHJvbml6YXRpb25cblx0XHRcdFx0d2luZG93LmRpc3BhdGNoRXZlbnQoXG5cdFx0XHRcdFx0bmV3IFN0b3JhZ2VFdmVudChgc3RvcmFnZWAsIHtcblx0XHRcdFx0XHRcdGtleSxcblx0XHRcdFx0XHRcdG5ld1ZhbHVlLFxuXHRcdFx0XHRcdFx0c3RvcmFnZUFyZWE6IGxvY2FsU3RvcmFnZSxcblx0XHRcdFx0XHR9KSxcblx0XHRcdFx0KTtcblx0XHRcdH0gY2F0Y2gge1xuXHRcdFx0XHQvLyBpZ25vcmUgZXJyb3JzXG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdGlmIChzdG9yYWdlU3luYykge1xuXHRcdFx0Y29uc3Qgb3JpZ2luYWxTZXQgPSBpbnRlcm5hbFNpZ25hbC5zZXQ7XG5cdFx0XHRjb25zdCBvcmlnaW5hbFVwZGF0ZSA9IGludGVybmFsU2lnbmFsLnVwZGF0ZTtcblxuXHRcdFx0Y29uc3Qgc2V0OiB0eXBlb2Ygb3JpZ2luYWxTZXQgPSAobmV3VmFsdWU6IFIpID0+IHtcblx0XHRcdFx0Ly8gc2V0IHRoZSB2YWx1ZSBpbiB0aGUgc2lnbmFsIHVzaW5nIHRoZSBvcmlnaW5hbCBzZXQgZnVuY3Rpb25cblx0XHRcdFx0b3JpZ2luYWxTZXQobmV3VmFsdWUpO1xuXG5cdFx0XHRcdC8vIHRoZW4gd2UgcmVmcmVzaCB0aGUgdmFsdWUgaW4gbG9jYWxTdG9yYWdlIGFuZCBub3RpZnkgb3RoZXIgY29uc3VtZXJzIGluIHRoaXMgdGFiIGFib3V0IHRoZSBjaGFuZ2Vcblx0XHRcdFx0c3luY1ZhbHVlV2l0aExvY2FsU3RvcmFnZShuZXdWYWx1ZSk7XG5cdFx0XHR9O1xuXG5cdFx0XHRjb25zdCB1cGRhdGU6IHR5cGVvZiBvcmlnaW5hbFVwZGF0ZSA9ICh1cGRhdGVGbjogKHZhbHVlOiBSKSA9PiBSKSA9PiB7XG5cdFx0XHRcdGxldCBuZXdWYWx1ZTogUjtcblxuXHRcdFx0XHQvLyBzZXQgdGhlIHZhbHVlIGluIHRoZSBzaWduYWwgdXNpbmcgdGhlIG9yaWdpbmFsIHNldCBmdW5jdGlvblxuXHRcdFx0XHRvcmlnaW5hbFVwZGF0ZSgodmFsdWUpID0+IChuZXdWYWx1ZSA9IHVwZGF0ZUZuKHZhbHVlKSkpO1xuXG5cdFx0XHRcdC8vIHRoZW4gd2UgcmVmcmVzaCB0aGUgdmFsdWUgaW4gbG9jYWxTdG9yYWdlIGFuZCBub3RpZnkgb3RoZXIgY29uc3VtZXJzIGluIHRoaXMgdGFiIGFib3V0IHRoZSBjaGFuZ2Vcblx0XHRcdFx0c3luY1ZhbHVlV2l0aExvY2FsU3RvcmFnZShuZXdWYWx1ZSEpO1xuXHRcdFx0fTtcblxuXHRcdFx0aW50ZXJuYWxTaWduYWwuc2V0ID0gc2V0O1xuXHRcdFx0aW50ZXJuYWxTaWduYWwudXBkYXRlID0gdXBkYXRlO1xuXG5cdFx0XHRjb25zdCBvblN0b3JhZ2UgPSAoZXZlbnQ6IFN0b3JhZ2VFdmVudCkgPT4ge1xuXHRcdFx0XHRpZiAoZXZlbnQuc3RvcmFnZUFyZWEgPT09IGxvY2FsU3RvcmFnZSAmJiBldmVudC5rZXkgPT09IGtleSkge1xuXHRcdFx0XHRcdGNvbnN0IG5ld1ZhbHVlID1cblx0XHRcdFx0XHRcdGV2ZW50Lm5ld1ZhbHVlICE9PSBudWxsXG5cdFx0XHRcdFx0XHRcdD8gKHBhcnNlKGV2ZW50Lm5ld1ZhbHVlKSBhcyBSKVxuXHRcdFx0XHRcdFx0XHQ6IGRlZmF1bHRWYWx1ZTtcblx0XHRcdFx0XHRpbnRlcm5hbFNpZ25hbC5zZXQobmV3VmFsdWUpO1xuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXG5cdFx0XHR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc3RvcmFnZScsIG9uU3RvcmFnZSk7XG5cdFx0XHRkZXN0cm95UmVmLm9uRGVzdHJveSgoKSA9PiB7XG5cdFx0XHRcdHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgb25TdG9yYWdlKTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHJldHVybiBpbnRlcm5hbFNpZ25hbDtcblx0fSk7XG59O1xuIl19